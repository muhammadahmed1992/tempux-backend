name: Deploy Dev Environment

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      # These are **passed through** to SSH so PM2 sees them.
      DATABASE_URL_DEV_USERS: ${{ secrets.DATABASE_URL_AUTH_DEV }}
      DATABASE_URL_DEV_PRODUCT: ${{ secrets.DATABASE_URL_PRODUCT_DEV }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      OTP_EXPIRY_DURATION: ${{ secrets.OTP_EXPIRY_DURATION }}
      MAIL_HOST: ${{ secrets.MAIL_HOST }}
      MAIL_PORT: ${{ secrets.MAIL_PORT }}
      MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
      MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
      MAIL_FROM: ${{ secrets.MAIL_FROM }}
      FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      GOOGLE_CALLBACK_URL: ${{ secrets.GOOGLE_CALLBACK_URL }}
      FACEBOOK_APP_ID: ${{ secrets.FACEBOOK_APP_ID }}
      FACEBOOK_APP_SECRET: ${{ secrets.FACEBOOK_APP_SECRET }}
      FACEBOOK_CALLBACK_URL: ${{ secrets.FACEBOOK_CALLBACK_URL }}
      EMAIL_ENCRYPTION_KEY: ${{ secrets.EMAIL_ENCRYPTION_KEY }}
      SALT_ROUND: ${{ secrets.SALT_ROUND }}
      AUTH_SERVICE_BASE_URL: ${{ secrets.AUTH_SERVICE_BASE_URL }}
      PRODUCT_SERVICE_BASE_URL: ${{ secrets.PRODUCT_SERVICE_BASE_URL }}
      USER_SERVICE_URL: ${{ secrets.USER_SERVICE_URL }}
      GATEWAY_PORT: ${{ secrets.GATEWAY_PORT }}
      AUTH_PORT: ${{ secrets.AUTH_PORT }}
      PRODUCT_PORT: ${{ secrets.PRODUCT_PORT }}
      CI: true

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: SSH Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: |
            DATABASE_URL_DEV_USERS
            DATABASE_URL_DEV_PRODUCT
            JWT_SECRET
            OTP_EXPIRY_DURATION
            MAIL_HOST
            MAIL_PORT
            MAIL_USERNAME
            MAIL_PASSWORD
            MAIL_FROM
            FRONTEND_URL
            GOOGLE_CLIENT_ID
            GOOGLE_CLIENT_SECRET
            GOOGLE_CALLBACK_URL
            FACEBOOK_APP_ID
            FACEBOOK_APP_SECRET
            FACEBOOK_CALLBACK_URL
            EMAIL_ENCRYPTION_KEY
            SALT_ROUND
            AUTH_SERVICE_BASE_URL
            PRODUCT_SERVICE_BASE_URL
            USER_SERVICE_URL
            GATEWAY_PORT
            AUTH_PORT
            PRODUCT_PORT
            CI
          script: |
            set -e

            PROJECT_DIR="/home/ubuntu/tempux-backend"
            echo "ðŸ‘‰ Pull latest code"
            cd "$PROJECT_DIR"
            git reset --hard HEAD
            git clean -df
            git fetch origin
            git checkout develop
            git pull origin develop

            echo "ðŸ‘‰ Ensure pnpm installed"
            npm config set prefix "$HOME/.npm-global"
            export PATH="$HOME/.npm-global/bin:$PATH"
            echo 'export PATH="$HOME/.npm-global/bin:$PATH"' >> ~/.bashrc

            npm install -g pnpm || true
            pnpm setup || true
            export PNPM_HOME="$HOME/.pnpm-global"
            export PATH="$PNPM_HOME:$PATH"
            echo "export PNPM_HOME=\"$PNPM_HOME\"" >> ~/.bashrc
            echo "export PATH=\"$PNPM_HOME:\$PATH\"" >> ~/.bashrc
            source ~/.bashrc

            echo "ðŸ‘‰ Install NestJS CLI + tsx"
            pnpm add -g tsx @nestjs/cli

            echo "ðŸ‘‰ Stop old PM2 processes"
            pm2 delete all || true

            echo "ðŸ‘‰ Install dependencies"
            pnpm install
            # Before prisma runs, and before pm2 start:
            export DATABASE_URL_DEV_USERS
            export DATABASE_URL_DEV_PRODUCT
            export JWT_SECRET
            export OTP_EXPIRY_DURATION
            export MAIL_HOST
            export MAIL_PORT
            export MAIL_USERNAME
            export MAIL_PASSWORD
            export MAIL_FROM
            export FRONTEND_URL
            export GOOGLE_CLIENT_ID
            export GOOGLE_CLIENT_SECRET
            export GOOGLE_CALLBACK_URL
            export FACEBOOK_APP_ID
            export FACEBOOK_APP_SECRET
            export FACEBOOK_CALLBACK_URL
            export EMAIL_ENCRYPTION_KEY
            export SALT_ROUND
            export AUTH_SERVICE_BASE_URL
            export PRODUCT_SERVICE_BASE_URL
            export USER_SERVICE_URL
            export GATEWAY_PORT
            export AUTH_PORT
            export PRODUCT_PORT

            echo "âœ… Env vars exported for PM2"

            echo "ðŸ‘‰ Migrate + seed for auth-service"
            cd "$PROJECT_DIR/auth-service"
            pnpm exec prisma migrate deploy --schema prisma/schema.prisma
            pnpm exec prisma db seed --schema prisma/schema.prisma
            pnpm exec prisma generate
            pnpm run build

            echo "ðŸ‘‰ Migrate + seed for product-service"
            cd "$PROJECT_DIR/product-service"
            pnpm exec prisma migrate deploy --schema prisma/schema.prisma
            pnpm exec prisma db seed --schema prisma/schema.prisma
            pnpm exec prisma generate
            pnpm run build

            cd "$PROJECT_DIR"

            echo "ðŸ‘‰ Start PM2 with production env"
            pm2 start ecosystem.config.ts --env production --update-env

            echo "âœ… Done"
